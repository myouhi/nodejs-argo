<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åå°ç®¡ç†</title>
<style>
  *, *::before, *::after {
      box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f0f2f5;
  }
  .app-container {
    display: flex;
    flex: 1;
    overflow: hidden;
  }
  
  .sidebar { 
    width: 280px;
    background: #ffffff;
    border-right: 1px solid #e0e0e0;
    padding: 0;
    display: flex; 
    flex-direction: column; 
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.03);
  }
  .sidebar-nav-section {
    padding: 15px 15px 10px 15px;
    border-bottom: 1px solid #f0f0f0;
  }
  .sidebar h2 { 
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    padding: 15px 15px 0 15px;
  }
  .main { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; }
  
  @media (max-width: 800px) { 
    .sidebar { display: none; }
    .app-container { flex-direction: column; }
    
    .main { 
        padding: 10px; 
    } 
    .mobile-nav-select { 
        display: block !important; 
    } 
    .form { flex-direction: column; } 
    .form input, .form select, .form button { 
        width: 100%; 
        min-width: unset; 
        padding: 12px; 
        font-size: 1rem;
    }
    .form-container {
        padding: 15px; 
    }
    #mobileCategoryControls {
      margin: 0 0 15px 0;
      padding: 12px 5px; 
      display: block !important;
      background: #fff; 
      border-radius: 8px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
    }
    
    #mobileCategoryControls input {
        margin-bottom: 8px; 
        padding: 10px; 
        font-size: 0.95rem; 
    }
    #mobileCategoryControls button {
        padding: 10px; 
        font-size: 0.95rem; 
    }
    
    .category-item {
        padding: 10px 10px; 
        margin-bottom: 4px; 
    }
    .category-item .category-name {
        font-size: 0.95rem; 
    }
    
    .bookmark {
        padding: 10px 5px; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        min-height: 100px;
    }
    .bookmark img {
        width: 35px; 
        height: 35px;
    }
    .bookmarks { 
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
        gap: 10px;
    }
    
    #pcCategoryControls {
        display: none !important;
    }
  }
  @media (min-width: 801px) {
      #pcCategoryControls {
          display: flex !important;
          flex-direction: column; 
      }
      #mobileCategoryControls {
          display: none !important;
      }
  }
  
  .bookmarks { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
    gap: 15px; 
  }
  .mobile-nav-select {
      display: none; 
      width: 100%;
      padding: 14px 30px 14px 15px; 
      margin-bottom: 15px; 
      border: 1px solid #ccc;
      border-radius: 10px; 
      font-size: 1.15rem; 
      box-sizing: border-box;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis; 
  }
  
  .pc-category-container {
      margin: 15px 15px 20px 15px;
      padding: 15px;
      background: #fcfcfc;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
  }
  .sidebar .pc-category-container {
      margin: 15px 15px 20px 15px; 
      padding: 15px; 
  }
  .pc-category-input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px; 
  }
  .pc-category-input-group input {
      padding: 10px;
      border-radius: 8px;
      border-color: #ddd;
  }
  .pc-category-input-group button {
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
      padding: 10px;
      border-radius: 8px;
      font-weight: 600;
  }
  
  .nav-item { 
      padding: 12px 15px;
      margin: 4px 0;
      cursor: pointer; 
      transition: all 0.2s ease-in-out; 
      font-weight: 500;
      color: #4a4a4a;
      border-radius: 8px;
  }
  .nav-item:not(.active):hover { 
    background: #f0f0f0;
    color: #1a73e8;
    transform: none; 
  }
  .nav-item.active { 
    background:#1a73e8; 
    color:white; 
    box-shadow: 0 4px 10px rgba(26, 115, 232, 0.25);
    transform: none; 
  }
  button, input, select, .category-item, .bookmark {
    transition: all 0.2s ease-in-out;
  }
  button { cursor: pointer; }
  button:hover { filter: brightness(1.15); transform: translateY(-2px); }
  button:active { filter: brightness(0.9); transform: translateY(0); }
  .category-list-pc { 
    overflow-y: auto; 
    padding: 5px 0; 
    border-top: none;
    margin-top: 5px;
    padding-top: 5px;
  }
  .category-item { 
    background: #ffffff;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    border: 1px solid #f0f0f0;
    padding: 10px 12px;
    margin: 6px 0;
    cursor: grab; 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    transition: all 0.2s ease-in-out; 
  }
  .category-item:active {
      cursor: grabbing; 
  }
  .category-item.dragging {
      opacity: 0.7; 
      transform: scale(0.98); 
      border: 1px dashed #1a73e8; 
      box-shadow: none;
  }
  .category-item.drag-over-top {
      border-top: 2px solid #1a73e8; 
      margin-top: 4px;
  }
  .category-item.drag-over-bottom {
      border-bottom: 2px solid #1a73e8; 
      margin-bottom: 4px;
  }
  .category-item.drag-over-center {
      background: #e6e6e6; 
      box-shadow: 0 0 0 2px #1a73e8 inset; 
      transform: none;
  }
  
  .category-item .category-name {
    font-size: 0.9rem;
    word-break: break-word; 
    flex-grow: 1;
    margin-right: 10px;
  }
  .category-item:not(.active):hover { 
    background: #f9f9f9; 
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  } 
  .category-item.active { 
    background:#1a73e8; 
    color:white; 
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
    transform: none; 
    border: 1px solid #1a73e8;
  }
  .category-item.active .category-name {
      color: white; 
  }
  .category-item button { 
    border: none; 
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 0.8rem;
    opacity: 0.95; 
    line-height: 1;
  }
  .category-item .edit-btn { 
      background: #555; 
      color: white;
  }
  .category-item .delete-btn { 
      background: #d32f2f; 
      color: white;
      margin-left: 6px;
  }
  
  .category-item.editing .edit-btn {
      background: #1a73e8;
      color: white;
  }
  .category-item.editing .delete-btn {
      background: #999;
      color: white;
  }
  .category-item:not(.active) .edit-btn:hover {
      filter: brightness(1.25);
  }
  .category-item:not(.active) .delete-btn:hover {
      filter: brightness(1.25);
  }
  .category-item.active .category-buttons button {
      background: white !important; 
      opacity: 1;
  }
  .category-item.active .edit-btn {
      color: #1a73e8 !important; 
  }
  .category-item.active .delete-btn {
      color: #d32f2f !important; 
  }
  .category-item input.edit-input {
    flex-grow: 1;
    padding: 4px;
    border: 1px solid #1a73e8;
    border-radius: 3px;
    outline: none;
    font-size: 0.9rem;
  }
  .hidden { display: none !important; }
  .category-buttons { display: flex; }
  .category-item.editing {
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .category-item.editing .category-name { display: none; }
  .category-item.editing .edit-input {
    display: block;
    flex-basis: 100%;
    margin-bottom: 6px;
  }
  .category-item.editing .category-buttons {
    flex-basis: 100%;
    justify-content: flex-end;
  }
  .form-container {
      background: #fff;
      border-radius: 8px;
      padding: 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 20px;
  }
  .form { display:flex; gap:10px; flex-wrap:wrap; margin:0; } 
  
  .form input, .form select { 
    padding:10px; 
    border-radius:6px; 
    border:1px solid #ccc; 
    flex:1; 
    min-width:150px; 
  }
  .form input:focus, .form select:focus { outline: none; border-color: #1a73e8; box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); }
  .form button { 
    padding:10px 15px; 
    border:none; 
    border-radius:6px; 
    background:#1a73e8; 
    color:white; 
  }
  @media (max-width: 800px) {
    .form input, .form select, .form button { 
        min-width: unset; 
    }
    .form-container {
        padding: 15px; 
    }
  }
  .bookmark { 
      background:#fff; 
      border-radius:8px; 
      box-shadow:0 2px 6px rgba(0,0,0,0.1); 
      padding:15px 10px; 
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      text-align:center; 
      cursor: grab; 
      transition: all 0.2s ease-in-out; 
      position: relative; 
      min-height: 120px; 
  }
  .bookmark:active {
      cursor: grabbing; 
  }
  .bookmark.dragging {
      opacity: 0.5; 
      transform: scale(0.98); 
  }
  .bookmark.drag-over {
      border: 2px dashed #1a73e8; 
      box-shadow: 0 0 0 4px rgba(26, 115, 232, 0.2);
      transform: scale(1.05); 
  }
  .bookmark:hover { 
      transform: none; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.15); 
  }
  .bookmark:active { 
      transform: none; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.12); 
  }
  .bookmark img { 
      width: 40px; 
      height: 40px; 
      margin-bottom: 5px; 
  }
  .bookmark span { 
      font-size: 0.95rem; 
      font-weight: 600; 
      word-break:break-word; 
      margin-bottom: 2px;
      color: #333;
      width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
  }
  .bookmark .bookmark-url { 
      font-size: 0.75rem;
      color: #999;
      margin-bottom: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 90%;
  }
  .bookmark-actions { 
      margin-top: auto; 
      display:flex; 
      gap: 8px; 
      width: 100%;
      opacity: 1; 
      padding: 0 5px;
  }
  .bookmark-actions button { 
      flex: 1; 
      padding: 4px 6px; 
      font-size: 0.8rem; 
      border-radius: 4px; 
      border:none; 
  }
  .bookmark-actions .edit-btn { background:#1a73e8; color:white; }
  .bookmark-actions .delete-btn { background:#e53935; color:white; }
  #passwordOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#f7f7f7; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:1000; padding-bottom: 40vh; box-sizing: border-box; }
  #passwordOverlay input { 
    padding: 12px 15px; 
    border-radius: 20px; 
    border: 1px solid #ccc; 
    margin-bottom: 15px; 
    width: 280px; 
    max-width: 90%; 
    font-size: 1.1rem; 
  }
  #passwordOverlay input:focus { 
    outline: none; 
    border-color: #1a73e8; 
    box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); 
  }
  #passwordOverlay button { 
    padding: 10px 20px; 
    border:none; 
    border-radius:5px; 
    background:#1a73e8; 
    color:white; 
  }
  .logo-manager { margin-bottom: 12px; display:block; } 
  
  .logo-preview-box {
      width: 100%;
      height: 100px; 
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .logo-preview-box img { 
    max-height: 80px; 
    max-width: 90%;
    width: auto; 
    height: auto;
    border-radius:0; 
    border:none; 
    background:transparent; 
    box-shadow: none;
    object-fit: contain;
  }
  .logo-input-group input { padding: 10px; }
  .avatar-setting-group {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
  }
  .avatar-setting-group input {
      flex-grow: 1;
      padding: 10px; 
      min-width: 250px;
  }
  
  .avatar-preview-box {
      width: 120px; 
      height: 120px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
      border: 3px solid #1a73e8; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      background: #eee;
  }
  .avatar-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover; 
      border-radius: 0;
      box-shadow: none;
      border: none;
      height: 100%;
      width: 100%;
      display: block;
  }
  @media (max-width: 600px) {
      .avatar-setting-group {
          flex-direction: column;
          align-items: flex-start;
      }
      .avatar-setting-group input {
          width: 100%;
      }
  }
  
  .wallpaper-setting-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
  }
  .wallpaper-setting-group label {
      display: flex;
      align-items: center;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 1px solid #eee;
      background: #f9f9f9;
  }
  .wallpaper-setting-group label:hover { background: #f0f0f0; }
  .wallpaper-setting-group label input[type="radio"] {
      margin-right: 10px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border: 2px solid #ccc;
      border-radius: 50%;
      outline: none;
      transition: border-color 0.2s, background-color 0.2s;
      position: relative;
      flex-shrink: 0;
  }
  .wallpaper-setting-group label input[type="radio"]:checked {
      border-color: #1a73e8;
      background-color: #1a73e8;
  }
  .wallpaper-setting-group label input[type="radio"]:checked::after {
      content: '';
      display: block;
      width: 6px;
      height: 6px;
      background: white;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
  }
  
  #wallpaperPreview {
    height: auto !important;
    max-height: 150px;
    width: 100%;
    object-fit: cover; 
    background: #ccc;
    border-radius: 8px; 
    margin-top: 15px;
    margin-bottom: 15px;
  }
  
  #customUrlContainer {
      border: 1px dashed #ccc;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      margin-top: -5px;
  }
  .logo-manager input { 
    width: 100%; 
    padding:8px; 
    border-radius:4px; 
    border:1px solid #ccc; 
    box-sizing: border-box;
  }
  .logo-save-btn { padding:6px 10px; border-radius:6px; border:none; background:#1a73e8; color:#fff; cursor:pointer; }
  
  .main > div { flex-shrink: 0; } 
  footer {
    flex-shrink: 0;
    padding: 15px;
    text-align: center;
    background: #f7f7f7;
    border-top: 1px solid #ddd;
    color: #777;
    font-size: 0.9rem;
  }
  footer p { margin: 0; }
  #adminNotification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4CAF50;
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      opacity: 0;
      top: -100px; 
      transition: opacity 0.3s, top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1000;
      font-weight: 500;
  }
  #adminNotification.show {
      opacity: 1;
      top: 20px;
  }
</style>
</head>
<body>

<div id="passwordOverlay">
  <h2>è¯·è¾“å…¥ç®¡ç†å¯†ç </h2>
  <input type="password" id="adminPasswordInput" placeholder="å¯†ç ">
  <button id="passwordSubmitBtn">è¿›å…¥ç®¡ç†</button>
  <p id="passwordError" style="display:none;">å¯†ç é”™è¯¯</p>
</div>

<div class="app-container">
  <div class="sidebar">
    
    <div class="sidebar-nav-section">
        <div id="navProfile" class="nav-item">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</div>
        <div id="navSettings" class="nav-item">âš™ï¸ å›¾æ ‡è®¾ç½®</div>
        <div id="navWallpaper" class="nav-item">ğŸ–¼ï¸ å£çº¸è®¾ç½®</div>
        <div id="navManagement" class="nav-item active">ğŸ“š ä¹¦ç­¾ç®¡ç†</div> 
    </div>
    
    <div id="pcCategoryControls" class="pc-category-container">
        <div class="pc-category-input-group">
            <input type="text" id="newCategoryPC" placeholder="æ–°å¢åˆ†ç±»">
            <button id="addCategoryBtnPC">æ·»åŠ </button>
        </div>
        <div id="categoryListPC" class="category-list-pc">
            </div>
    </div>
  </div>

  <div class="main">
    
    <select id="mobileNavSelect" class="mobile-nav-select">
        <option value="profileView">ğŸ‘¤ ä¸ªäººä¸­å¿ƒ</option>
        <option value="settingsView">âš™ï¸ å›¾æ ‡è®¾ç½®</option>
        <option value="wallpaperView">ğŸ–¼ï¸ å£çº¸è®¾ç½®</option>
        <option value="managementView">ğŸ“š ä¹¦ç­¾ç®¡ç†</option>
    </select>
    
    <div id="managementView" style="display:flex; flex-direction:column; flex:1;">
        <h2 style="background: #1a73e8; color: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px;">
            <span style="font-size: 1.2rem; margin-right: 10px;">ğŸ“š</span> ä¹¦ç­¾ç®¡ç†
        </h2>
        
        <div id="mobileCategoryControls" class="pc-category-container">
            <div style="padding-top: 0;">
                <input type="text" id="newCategoryMobile" placeholder="æ–°å¢åˆ†ç±»">
                <button id="addCategoryBtnMobile">æ·»åŠ åˆ†ç±»</button>
            </div>
            <div id="categoryListMobile" style="max-height: 400px; overflow-y:auto;">
                 </div>
        </div>

        <div class="form-container">
            <div class="form">
              <input type="text" id="bookmarkName" placeholder="ä¹¦ç­¾åç§°">
              <input type="text" id="bookmarkUrl" placeholder="ä¹¦ç­¾URL">
              <input type="text" id="bookmarkIcon" placeholder="å›¾æ ‡URL (å¯é€‰)">
              <select id="bookmarkCategory"></select>
              <button id="saveBtn">ä¿å­˜ä¹¦ç­¾</button>
            </div>
        </div>
        
        <div class="bookmarks" id="bookmarkList"></div>
    </div>
    
    <div id="profileView" class="hidden">
        <h2>ä¸ªäººä¸­å¿ƒ</h2>
        <p style="color:#777; margin-top:-10px; margin-bottom: 20px;">è®¾ç½®æ‚¨çš„ç®¡ç†è´¦æˆ·å¤´åƒç­‰ä¸ªäººä¿¡æ¯ã€‚</p>

        <div style="background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;">
            <h3 style="margin-top:0;">ç®¡ç†å¤´åƒ URL</h3>
            
            <div class="avatar-setting-group">
                <div class="avatar-preview-box">
                    <img id="avatarPreview" src="" alt="å¤´åƒé¢„è§ˆ" style="display:none;">
                </div>
                <input id="avatarInput" type="text" placeholder="å¤´åƒ URL (ä¾‹å¦‚ https://example.com/avatar.jpg)">
            </div>
            
            <small style="color:#666; margin-bottom:10px; display:block;">é¦–é¡µå³ä¸Šè§’æ˜¾ç¤ºçš„åœ†å½¢ä¸ªäººå¤´åƒã€‚</small>
        </div>
        
        <div style="margin-top:20px;">
          <button id="saveProfileBtn" class="logo-save-btn" data-type="profile" style="padding:10px 20px;">ä¿å­˜ä¸ªäººè®¾ç½®</button>
        </div>
    </div>
    
    <div id="settingsView" class="hidden">
        <h2>å›¾æ ‡è®¾ç½®</h2>
        <p style="color:#777; margin-top:-10px; margin-bottom: 20px;">è®¾ç½®ç½‘ç«™é¡¶éƒ¨å›¾æ ‡ã€‚</p>

        <div style="background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;">
            <h3 style="margin-top:0;">ç®¡ç†å›¾æ ‡ URL</h3>
            
            <div class="logo-preview-box">
                <img id="logoPreview" src="" alt="å›¾æ ‡é¢„è§ˆ" style="display:none;">
            </div>
            
            <div class="logo-manager logo-input-group">
                <input id="logoInput" type="text" placeholder="å›¾æ ‡ URL (ä¾‹å¦‚ https://example.com/logo.png)">
            </div>
            
            <small style="color:#666; margin-bottom:20px; display:block;">åœ¨æ­¤è®¾ç½®é¡¶éƒ¨ç½‘ç«™å›¾æ ‡ï¼Œä¿å­˜åé¦–é¡µä¼šæ˜¾ç¤º</small>
        </div>

        <div style="margin-top:20px;">
          <button id="saveLogoBtn" class="logo-save-btn" data-type="logo" style="padding:10px 20px;">ä¿å­˜å›¾æ ‡</button>
        </div>
    </div>
    
    <div id="wallpaperView" class="hidden">
        <h2>å£çº¸è®¾ç½®</h2>
        <p style="color:#777; margin-top:-10px; margin-bottom: 20px;">è®¾ç½®ç½‘ç«™èƒŒæ™¯å£çº¸ï¼Œå¯é€‰æ‹©æ¯æ—¥è‡ªåŠ¨æ›´æ–°ã€‚</p>
        
        <div style="background:#fff; border-radius:8px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px;">
            <h3 style="margin-top:0;">é€‰æ‹©å£çº¸æ¨¡å¼</h3>
            
            <div class="wallpaper-setting-group">
                <label>
                    <input type="radio" name="wallpaperMode" value="none" id="modeNone">
                    çº¯è‰²èƒŒæ™¯ (ä¸ä½¿ç”¨å£çº¸)
                </label>
                <label>
                    <input type="radio" name="wallpaperMode" value="bing" id="modeBing">
                    æ¯æ—¥è‡ªåŠ¨æ›´æ–° (Bing æ¯æ—¥å£çº¸)
                </label>
                <label>
                    <input type="radio" name="wallpaperMode" value="custom" id="modeCustom">
                    è‡ªå®šä¹‰ URL
                </label>
            </div>
            
            <img id="wallpaperPreview" src="" alt="å£çº¸é¢„è§ˆ" style="display:none;">
    
            <div id="customUrlContainer" class="hidden">
                <h3 style="margin-top:5px;">è‡ªå®šä¹‰å£çº¸ URL</h3>
                <div class="logo-manager">
                    <input id="wallpaperInput" type="text" placeholder="å£çº¸å›¾ç‰‡ URL">
                </div>
            </div>
            
            <small id="wallpaperTip" style="color:#666; margin-top:15px; display:block;">è¯·é€‰æ‹©æˆ–è¾“å…¥æ‚¨çš„å£çº¸ã€‚</small>
        </div>

        <div style="margin-top:20px;">
          <button id="saveWallpaperBtn" class="logo-save-btn" data-type="wallpaper" style="padding:10px 20px;">ä¿å­˜å£çº¸</button>
        </div>
    </div>

  </div>
</div>

<footer>
  <p>&copy; <span id="currentYear"></span> åå°ç®¡ç†. ç”± å¯¼èˆªç«™ å¼ºåŠ›é©±åŠ¨.</p>
</footer>

<div id="adminNotification"></div>


<script>
let bookmarksData = {};
let categoriesList = []; 
let verifiedPassword = null;
let editingIndex = null, editingCategoryPath = null;
let currentCategoryPath = ""; 
let passwordTimeout = null;
const PASSWORD_DURATION = 10 * 60 * 1000;
const BING_PREVIEW_URL = "https://www.bing.com/th?id=OHR.PontePietra_EN-US3267576571_1920x1080.jpg&pid=hp"; 
const DROP_MARGIN = 0.3;
let draggedBookmarkIndex = null;

const nameInput = document.getElementById("bookmarkName");
const urlInput = document.getElementById("bookmarkUrl");
const iconInput = document.getElementById("bookmarkIcon");
const categorySelect = document.getElementById("bookmarkCategory");
const saveBtn = document.getElementById("saveBtn");
const listContainer = document.getElementById("bookmarkList");

const overlay = document.getElementById("passwordOverlay");
const passwordInput = document.getElementById("adminPasswordInput");
const passwordBtn = document.getElementById("passwordSubmitBtn");
const passwordError = document.getElementById("passwordError");

const logoInput = document.getElementById("logoInput");
const logoPreview = document.getElementById("logoPreview");
const saveLogoBtn = document.getElementById("saveLogoBtn");

const navProfile = document.getElementById("navProfile");
const profileView = document.getElementById("profileView");
const avatarInput = document.getElementById("avatarInput");
const avatarPreview = document.getElementById("avatarPreview");
const saveProfileBtn = document.getElementById("saveProfileBtn");


const wallpaperInput = document.getElementById("wallpaperInput");
const wallpaperPreview = document.getElementById("wallpaperPreview");
const saveWallpaperBtn = document.getElementById("saveWallpaperBtn");
const modeNone = document.getElementById("modeNone");
const modeBing = document.getElementById("modeBing");
const modeCustom = document.getElementById("modeCustom");
const customUrlContainer = document.getElementById("customUrlContainer");
const wallpaperTip = document.getElementById("wallpaperTip");

const navSettings = document.getElementById("navSettings");
const navWallpaper = document.getElementById("navWallpaper"); 
const navManagement = document.getElementById("navManagement"); 
const settingsView = document.getElementById("settingsView");
const wallpaperView = document.getElementById("wallpaperView"); 
const managementView = document.getElementById("managementView"); 

const pcCategoryControls = document.getElementById("pcCategoryControls");
const newCategoryInputPC = document.getElementById("newCategoryPC");
const addCategoryBtnPC = document.getElementById("addCategoryBtnPC");
const categoryListPC = document.getElementById("categoryListPC");

const mobileCategoryControls = document.getElementById("mobileCategoryControls");
const newCategoryInputMobile = document.getElementById("newCategoryMobile");
const addCategoryBtnMobile = document.getElementById("addCategoryBtnMobile");
const categoryListMobile = document.getElementById("categoryListMobile");

const notificationEl = document.getElementById("adminNotification");
let notificationTimeoutId = null; 

function showSuccessMessage(message) {
    if (notificationTimeoutId) {
        clearTimeout(notificationTimeoutId);
    }
    
    notificationEl.textContent = message;
    notificationEl.classList.add('show');
    
    notificationTimeoutId = setTimeout(() => {
        notificationEl.classList.remove('show');
        notificationTimeoutId = null;
    }, 3000);
}


function switchView(viewId) {
    currentView = viewId;
    
    profileView.classList.add('hidden');
    settingsView.classList.add('hidden');
    wallpaperView.classList.add('hidden'); 
    managementView.classList.add('hidden'); 

    navProfile.classList.remove('active');
    navSettings.classList.remove('active');
    navWallpaper.classList.remove('active'); 
    navManagement.classList.remove('active'); 

    const mobileNavSelect = document.getElementById("mobileNavSelect");
    if (mobileNavSelect) mobileNavSelect.value = viewId; 
    
    if (viewId === 'managementView') {
        navManagement.classList.add('active');
        managementView.classList.remove('hidden');
        renderCategoryList(); 
        renderBookmarkList(); 

    } else if (viewId === 'profileView') {
        navProfile.classList.add('active');
        profileView.classList.remove('hidden');
        
    } else if (viewId === 'settingsView') {
        navSettings.classList.add('active');
        settingsView.classList.remove('hidden');
    } else if (viewId === 'wallpaperView') { 
        navWallpaper.classList.add('active');
        wallpaperView.classList.remove('hidden');
        const mode = modeBing.checked ? 'bing' : (modeCustom.checked ? 'custom' : 'none');
        updateWallpaperView(mode); 
    }
}


const mobileNavSelect = document.getElementById("mobileNavSelect");
if (mobileNavSelect) {
    mobileNavSelect.addEventListener('change', (e) => {
        switchView(e.target.value);
    });
}

navProfile.onclick = () => switchView('profileView'); 
navSettings.onclick = () => switchView('settingsView');
navWallpaper.onclick = () => switchView('wallpaperView'); 
navManagement.onclick = () => switchView('managementView'); 


function normalizeUrl(url) {
  let cleanedUrl = url.trim();
  if (cleanedUrl && !cleanedUrl.startsWith('http://') && !cleanedUrl.startsWith('https://')) {
    cleanedUrl = 'https://' + cleanedUrl;
  }
  return cleanedUrl;
}

function findCategoryAndParent(path, list = categoriesList, parent = null) {
  if (!path) return {};
  const parts = path.split(' / ');
  const name = parts[0];
  
  for (let i = 0; i < list.length; i++) {
    const item = list[i];
    if (item.name === name) {
      if (parts.length === 1) {
        return { category: item, parentList: list, index: i, parent: parent };
      }
      if (item.children && item.children.length > 0) {
        const remainingPath = parts.slice(1).join(' / ');
        const found = findCategoryAndParent(remainingPath, item.children, item);
        if (found.category) return found;
      }
    }
  }
  return {};
}

function getFlatCategories(list = categoriesList, prefix = "") {
  let flatList = [];
  list.forEach(item => {
    const fullName = prefix + item.name;
    flatList.push(fullName); 
    if (item.children && item.children.length > 0) {
      flatList = flatList.concat(getFlatCategories(item.children, fullName + " / "));
    }
  });
  return flatList;
}


function updateWallpaperView(mode) {
    if (mode === 'custom') {
        customUrlContainer.classList.remove('hidden');
        wallpaperTip.textContent = "å½“å‰æ¨¡å¼ï¼šè‡ªå®šä¹‰ URLã€‚è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„å›¾ç‰‡é“¾æ¥ã€‚";
        const v = wallpaperInput.value.trim();
        wallpaperPreview.style.display = 'block'; 
        if(v) {
            wallpaperPreview.src = v;
        } else {
            wallpaperPreview.src = "";
        }
    } else {
        customUrlContainer.classList.add('hidden');
        if (mode === 'bing') {
            wallpaperTip.textContent = "å½“å‰æ¨¡å¼ï¼šBing æ¯æ—¥å£çº¸ã€‚å¯¼èˆªé¡µå°†è‡ªåŠ¨åŠ è½½å½“æ—¥é«˜æ¸…å£çº¸ã€‚";
            wallpaperPreview.src = BING_PREVIEW_URL;
            wallpaperPreview.style.display = 'block';
        } else { 
            wallpaperTip.textContent = "å½“å‰æ¨¡å¼ï¼šçº¯è‰²èƒŒæ™¯ã€‚ä¸ä½¿ç”¨ä»»ä½•å£çº¸ã€‚";
            wallpaperPreview.src = "";
            wallpaperPreview.style.display = 'none';
        }
    }
}

modeNone.addEventListener('change', () => updateWallpaperView('none'));
modeBing.addEventListener('change', () => updateWallpaperView('bing'));
modeCustom.addEventListener('change', () => updateWallpaperView('custom'));

async function loadInitialData() {
  try {
    const response = await fetch(`/api/bookmarks?t=${new Date().getTime()}`);
    if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯ï¼ŒçŠ¶æ€ç : ' + response.status);
    let data = await response.json();
    if (data && data.bookmarksData) data = data.bookmarksData;
    bookmarksData = data || {};

    categoriesList = bookmarksData.categories || []; 

    if (bookmarksData.logo) {
      logoInput.value = bookmarksData.logo;
      logoPreview.src = bookmarksData.logo;
      logoPreview.style.display = "block"; 
    } else {
      logoInput.value = "";
      logoPreview.src = ""; 
      logoPreview.style.display = "none";
    }
    
    if (bookmarksData.adminAvatar) {
      avatarInput.value = bookmarksData.adminAvatar;
      avatarPreview.src = bookmarksData.adminAvatar;
      avatarPreview.style.display = "block"; 
    } else {
      avatarInput.value = "";
      avatarPreview.src = ""; 
      avatarPreview.style.display = "none";
    }

    const wallpaper = bookmarksData.wallpaper;
    if (wallpaper === 'bing') {
        modeBing.checked = true;
    } else if (wallpaper && wallpaper.startsWith('http')) {
        modeCustom.checked = true;
        wallpaperInput.value = wallpaper;
    } else {
        modeNone.checked = true;
    }
    updateWallpaperView(modeBing.checked ? 'bing' : (modeCustom.checked ? 'custom' : 'none'));

    const flatCategories = getFlatCategories();
    if (flatCategories.length > 0 && !findCategoryAndParent(currentCategoryPath).category) {
        currentCategoryPath = flatCategories[0];
    }
    
    renderCategoryOptions();
    renderCategoryList();
    renderBookmarkList();
    
    switchView('managementView'); 

  } catch (error) {
    console.error('Failed to load bookmarks:', error);
  }
}

logoInput.addEventListener('input', (e) => {
  const v = e.target.value.trim();
  if (v) {
    logoPreview.src = v;
    logoPreview.style.display = "block"; 
  } else {
    logoPreview.src = ""; 
    logoPreview.style.display = "none"; 
  }
});

avatarInput.addEventListener('input', (e) => {
  const v = e.target.value.trim();
  if (v) {
    avatarPreview.src = v;
    avatarPreview.style.display = "block"; 
  } else {
    avatarPreview.src = ""; 
    avatarPreview.style.display = "none"; 
  }
});

wallpaperInput.addEventListener('input', (e) => {
  if(modeCustom.checked) {
      wallpaperPreview.style.display = 'block';
      const v = e.target.value.trim();
      if (v) {
        wallpaperPreview.src = v;
      } else {
        wallpaperPreview.src = ""; 
      }
  }
});

async function saveDataToServer(successMessage = "é…ç½®ä¿å­˜æˆåŠŸ") { 
  if (!verifiedPassword) {
    alert("æ— æ³•ä¿å­˜æ•°æ®ï¼šå¯†ç æœªéªŒè¯ã€‚è¯·åˆ·æ–°åé‡æ–°ç™»å½•ã€‚");
    return;
  }
  
  const logoVal = logoInput.value.trim();
  const avatarVal = avatarInput.value.trim(); 
  let wallpaperVal;
  
  if (modeBing.checked) {
      wallpaperVal = 'bing'; 
  } else if (modeCustom.checked) {
      wallpaperVal = wallpaperInput.value.trim();
  } else { 
      wallpaperVal = undefined; 
  }

  bookmarksData.logo = logoVal || undefined;
  bookmarksData.adminAvatar = avatarVal || undefined; 
  bookmarksData.wallpaper = wallpaperVal;
  bookmarksData.categories = categoriesList;

  try {
    const response = await fetch('/api/bookmarks', {
      method: 'POST',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        password: verifiedPassword,
        bookmarksData: bookmarksData,
      }),
    });
    const result = await response.json();
    if (!response.ok || !result.success) throw new Error(result.message || `ä¿å­˜å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
    
    showSuccessMessage(successMessage);
    
  } catch (error) {
    console.error('Error saving data to server:', error);
    alert(`ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼é”™è¯¯: ${error.message}`);
  }
}

saveLogoBtn.addEventListener('click', () => saveDataToServer("å›¾æ ‡è®¾ç½®ä¿å­˜æˆåŠŸ"));
saveWallpaperBtn.addEventListener('click', () => saveDataToServer("å£çº¸è®¾ç½®ä¿å­˜æˆåŠŸ")); 
saveProfileBtn.addEventListener('click', () => saveDataToServer("ä¸ªäººè®¾ç½®ä¿å­˜æˆåŠŸ")); 


async function checkPassword() {
  const password = passwordInput.value;
  
  passwordError.style.display = "none";
  passwordError.textContent = "å¯†ç é”™è¯¯"; 

  if (!password) {
      return; 
  }

  try {
    const res = await fetch("/check-password", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.success) {
      sessionStorage.setItem('verifiedPassword', password);
      sessionStorage.setItem('verifiedTime', Date.now());
      handleSuccessfulLogin(password);
    } else {
      passwordError.style.display = "block";
      passwordInput.value = "";
      
      setTimeout(() => {
          passwordError.style.display = "none";
      }, 5000); 
    }
  } catch (err) {
    console.error(err);
    passwordError.style.display = "block";
    
    setTimeout(() => {
        passwordError.style.display = "none";
    }, 5000); 
  }
}

function handleSuccessfulLogin(password) {
    verifiedPassword = password;
    overlay.style.display = "none";
    passwordInput.value = "";
    passwordError.style.display = "none";
    startPasswordTimer();
    loadInitialData(); 
}

function checkSessionLogin() {
    const storedPassword = sessionStorage.getItem('verifiedPassword');
    const storedTime = sessionStorage.getItem('verifiedTime');
    if (storedPassword && storedTime) {
        const elapsedTime = Date.now() - parseInt(storedTime, 10);
        if (elapsedTime < PASSWORD_DURATION) {
            handleSuccessfulLogin(storedPassword);
        } else {
            sessionStorage.clear();
        }
    }
}

function startPasswordTimer() {
    if (passwordTimeout) clearTimeout(passwordTimeout);
    passwordTimeout = setTimeout(() => {
        sessionStorage.clear();
        verifiedPassword = null;
        overlay.style.display = "flex";
        alert("ç™»å½•å·²è¶…æ—¶ï¼Œè¯·é‡æ–°è¾“å…¥å¯†ç ã€‚");
    }, PASSWORD_DURATION);
}

if (passwordBtn) {
    passwordBtn.onclick = checkPassword;
} else {
    console.error('âŒ è‡´å‘½é”™è¯¯ï¼šæœªæ‰¾åˆ° ID ä¸º "passwordSubmitBtn" çš„å…ƒç´ ï¼è¯·æ£€æŸ¥ HTML ID æ‹¼å†™ã€‚');
}

passwordInput.addEventListener("keydown", (event) => {
  if (event.key === "Enter") {
    event.preventDefault();
    checkPassword();
  }
});

function renderCategoryOptions(selectedPath = null) {
  categorySelect.innerHTML = "";
  const flatCategories = getFlatCategories();
  if (flatCategories.length === 0) {
      const option = document.createElement("option");
      option.textContent = "è¯·å…ˆæ·»åŠ ä¸€ä¸ªåˆ†ç±»";
      option.disabled = true;
      categorySelect.appendChild(option);
      return;
  }
  let actualSelected = selectedPath || currentCategoryPath || flatCategories[0];
  if (!flatCategories.includes(actualSelected)) actualSelected = flatCategories[0];
  
  flatCategories.forEach(path => {
    const option = document.createElement("option");
    option.value = path;
    option.textContent = path;
    if (path === actualSelected) option.selected = true;
    categorySelect.appendChild(option);
  });
}

function renderCategoryList() {
    const containerPC = categoryListPC; 
    const containerMobile = categoryListMobile; 

    if (!containerPC || !containerMobile) return; 

    containerPC.innerHTML = "";
    containerMobile.innerHTML = "";

    renderCategoryListRecursive(categoriesList, containerPC, 0);
    renderCategoryListRecursive(categoriesList, containerMobile, 0);
}

function renderCategoryListRecursive(list, container, level, pathPrefix = "") {
    list.forEach(catItem => {
        const fullPath = pathPrefix + catItem.name;
        
        const div = createCategoryItem(catItem.name, fullPath, level); 
        
        container.appendChild(div);

        if (catItem.children && catItem.children.length > 0) {
            renderCategoryListRecursive(catItem.children, container, level + 1, fullPath + " / ");
        }
    });
}


let draggedItem = null; 

function handleDragStart(e) {
    draggedItem = e.target;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedItem.dataset.fullPath); 
    
    setTimeout(() => {
        draggedItem.classList.add('dragging');
    }, 0);
}

function handleDragOver(e) {
    e.preventDefault(); 
    
    const dropTargetEl = e.target.closest('.category-item');
    
    e.currentTarget.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-center').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-center');
    });

    if (dropTargetEl && dropTargetEl !== draggedItem) {
        const draggedPath = draggedItem.dataset.fullPath;
        const targetPath = dropTargetEl.dataset.fullPath;
        
        if (targetPath.startsWith(draggedPath) && targetPath !== draggedPath) {
             e.dataTransfer.dropEffect = 'none';
             return; 
        }

        const rect = dropTargetEl.getBoundingClientRect();
        const y = e.clientY - rect.top;

        if (y < rect.height * DROP_MARGIN) {
            dropTargetEl.classList.add('drag-over-top');
        } else if (y > rect.height * (1 - DROP_MARGIN)) {
            dropTargetEl.classList.add('drag-over-bottom');
        } else {
            dropTargetEl.classList.add('drag-over-center');
        }
        e.dataTransfer.dropEffect = 'move';
    }
}

function handleDragLeave(e) {
    e.preventDefault();
    e.target.closest('.category-item')?.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-center');
}

function handleDrop(e) {
    e.preventDefault();
    
    const dropTargetEl = e.target.closest('.category-item');
    
    if (dropTargetEl && draggedItem !== dropTargetEl) {
        const draggedPath = e.dataTransfer.getData('text/plain');
        const targetPath = dropTargetEl.dataset.fullPath;

        const rect = dropTargetEl.getBoundingClientRect();
        const y = e.clientY - rect.top; 
        
        if (targetPath.startsWith(draggedPath) && targetPath !== draggedPath) {
             alert("æ— æ³•å°†åˆ†ç±»åµŒå¥—åˆ°å…¶è‡ªèº«æˆ–å­åˆ†ç±»ä¸­ï¼");
             return; 
        }
        
        if (y > rect.height * DROP_MARGIN && y < rect.height * (1 - DROP_MARGIN)) {
            nestCategory(draggedPath, targetPath);
            saveDataToServer("åˆ†ç±»åµŒå¥—æˆåŠŸ");
        } else {
            const position = y < rect.height / 2 ? 'before' : 'after';
            updateCategoryOrder(draggedPath, targetPath, position); 
            saveDataToServer("åˆ†ç±»æ’åºæˆåŠŸ");
        }
    }
    handleDragEnd(e);
}

function handleDragEnd(e) {
    if (draggedItem) {
        draggedItem.classList.remove('dragging');
    }
    draggedItem = null;
    e.currentTarget.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-center').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-center');
    });
}


function nestCategory(draggedPath, targetPath) {
    const draggedInfo = findCategoryAndParent(draggedPath);
    const targetInfo = findCategoryAndParent(targetPath);

    if (!draggedInfo.category || !targetInfo.category) return;
    
    draggedInfo.parentList.splice(draggedInfo.index, 1);
    
    if (!targetInfo.category.children) {
        targetInfo.category.children = [];
    }
    targetInfo.category.children.push(draggedInfo.category);

    if (currentCategoryPath.startsWith(draggedPath)) {
        const suffix = currentCategoryPath.substring(draggedPath.length);
        currentCategoryPath = targetPath + " / " + draggedInfo.category.name + suffix;
    }

    renderCategoryList();
    renderCategoryOptions(currentCategoryPath);
}

function updateCategoryOrder(draggedPath, targetPath, position) {
    const draggedInfo = findCategoryAndParent(draggedPath);
    const targetInfo = findCategoryAndParent(targetPath);

    if (!draggedInfo.category || !targetInfo.category) return;

    const [removedItem] = draggedInfo.parentList.splice(draggedInfo.index, 1);
    
    const targetParentList = targetInfo.parentList;
    let insertIndex = targetInfo.index;

    if (position === 'after') {
        insertIndex = targetInfo.index + 1;
    } else if (position === 'before') {
        insertIndex = targetInfo.index;
    }
    
    targetParentList.splice(insertIndex, 0, removedItem);
    
    const targetPathParts = targetPath.split(' / ');
    const targetParentPath = targetPathParts.slice(0, -1).join(' / ');
    
    const newPath = targetParentPath ? targetParentPath + ' / ' + removedItem.name : removedItem.name;
    
    if (currentCategoryPath.startsWith(draggedPath)) {
        const suffix = currentCategoryPath.substring(draggedPath.length);
        currentCategoryPath = newPath + suffix;
    }
    
    renderCategoryList();
    renderCategoryOptions(currentCategoryPath);
}
function createCategoryItem(name, fullPath, level) {
    const div = document.createElement("div");
    const isActive = fullPath === currentCategoryPath;
    
    div.className = "category-item" + (isActive ? " active" : "");
    div.style.paddingLeft = `${15 + level * 20}px`;
    
    div.setAttribute('draggable', 'true'); 
    div.dataset.fullPath = fullPath; 
    div.dataset.categoryName = name;
    
    div.innerHTML = `
        <span class="category-name">${name}</span>
        <input type="text" class="edit-input hidden" value="${name}">
        <div class="category-buttons">
            <button class="edit-btn">ç¼–è¾‘</button>
            <button class="delete-btn">åˆ é™¤</button>
        </div>
    `;

    div.addEventListener('dragstart', handleDragStart);
    div.addEventListener('dragover', handleDragOver);
    div.addEventListener('dragleave', handleDragLeave);
    div.addEventListener('drop', handleDrop);
    div.addEventListener('dragend', handleDragEnd);

    const nameSpan = div.querySelector('.category-name');
    const editInput = div.querySelector('.edit-input');
    const editBtn = div.querySelector('.edit-btn');
    const deleteBtn = div.querySelector('.delete-btn');


    div.onclick = (e) => {
        if (!e.target.closest('button') && !e.target.closest('input') && !div.classList.contains('editing')) {
            currentCategoryPath = fullPath;
            renderCategoryList(); 
            renderBookmarkList(); 
            renderCategoryOptions();
        }
    };
    
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        
        if (div.classList.contains('editing')) {
             div.classList.remove('editing');
             editBtn.textContent = 'ç¼–è¾‘';
             deleteBtn.textContent = 'åˆ é™¤';
             renderCategoryList();
             return;
        }
        
        if (confirm(`ç¡®å®šåˆ é™¤åˆ†ç±» "${fullPath}" åŠå…¶ä¸­æ‰€æœ‰ä¹¦ç­¾å’Œå­åˆ†ç±»å—ï¼Ÿ`)) {
            deleteCategory(fullPath, true);
        }
    };
    
    editBtn.onclick = (e) => {
        e.stopPropagation();
        
        if (div.classList.contains('editing')) {
             handleUpdate();
        } else {
             document.querySelectorAll('.category-item.editing').forEach(el => {
                el.classList.remove('editing');
                el.querySelector('.edit-btn').textContent = 'ç¼–è¾‘';
                el.querySelector('.delete-btn').textContent = 'åˆ é™¤';
             });

             div.classList.add('editing');
             nameSpan.classList.add('hidden');
             editInput.classList.remove('hidden');
             editInput.value = name;
             editInput.focus();
             editInput.select();
             
             editBtn.textContent = 'ä¿å­˜';
             deleteBtn.textContent = 'å–æ¶ˆ';
        }
    };
    
    const handleUpdate = () => {
        if (!div.classList.contains('editing')) return;
        
        const newCatName = editInput.value.trim();
        let msg = "";
        
        if (newCatName && newCatName !== name) {
            updateCategoryName(fullPath, newCatName);
            msg = `åˆ†ç±» [${newCatName}] ä¿®æ”¹æˆåŠŸ`;
        } else {
             renderCategoryList(); 
        }
        
        div.classList.remove('editing');
        editBtn.textContent = 'ç¼–è¾‘';
        deleteBtn.textContent = 'åˆ é™¤';
        
        if (msg) showSuccessMessage(msg);
    };

    editInput.addEventListener('blur', handleUpdate); 
    
    editInput.onkeydown = (e) => {
        e.stopPropagation();
        if (e.key === 'Enter') {
            e.preventDefault();
            editInput.removeEventListener('blur', handleUpdate);
            handleUpdate();
        } else if (e.key === 'Escape') {
            e.preventDefault();
            div.classList.remove('editing');
            editBtn.textContent = 'ç¼–è¾‘';
            deleteBtn.textContent = 'åˆ é™¤';
            renderCategoryList();
        }
    };

    return div;
}

function handleAddCategory(inputElementId) {
    const inputElement = document.getElementById(inputElementId);
    if (!inputElement) return;

    const newName = inputElement.value.trim();
    if (!newName) return alert("åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©º");
    
    if (categoriesList.some(c => c.name === newName)) return alert("é¡¶çº§åˆ†ç±»å·²å­˜åœ¨åŒååˆ†ç±»");
    
    categoriesList.push({ name: newName, bookmarks: [], children: [] });
    
    if (!currentCategoryPath) currentCategoryPath = newName;
    
    saveDataToServer("åˆ†ç±» [" + newName + "] æ·»åŠ æˆåŠŸ");
    
    inputElement.value = "";
    
    renderCategoryList();
    renderCategoryOptions();
    renderBookmarkList(); 
}

if (addCategoryBtnPC) addCategoryBtnPC.onclick = () => handleAddCategory('newCategoryPC'); 
if (addCategoryBtnMobile) addCategoryBtnMobile.onclick = () => handleAddCategory('newCategoryMobile'); 


function deleteCategory(path, confirmed = false) {
  const info = findCategoryAndParent(path);
  if (!info.category) return;
  
  if (!confirmed) {
      return; 
  }
  
  const deletedName = info.category.name;

  info.parentList.splice(info.index, 1);

  const flatCategories = getFlatCategories();
  if (currentCategoryPath === path) {
      currentCategoryPath = flatCategories.length > 0 ? flatCategories[0] : "";
  } else if (currentCategoryPath.startsWith(path)) {
       currentCategoryPath = flatCategories.length > 0 ? flatCategories[0] : "";
  }
  
  saveDataToServer(`åˆ†ç±» [${deletedName}] åˆ é™¤æˆåŠŸ`);
  renderCategoryOptions();
  renderCategoryList();
  renderBookmarkList();
}

function updateCategoryName(oldPath, newName) {
  if (!newName) return alert("åˆ†ç±»åç§°ä¸èƒ½ä¸ºç©ºï¼");
  
  const oldInfo = findCategoryAndParent(oldPath);
  if (!oldInfo.category) return;
  
  if (oldInfo.parentList.some(c => c.name === newName && c !== oldInfo.category)) {
      return alert("åŒçº§åˆ†ç±»å·²å­˜åœ¨åŒååˆ†ç±»ï¼");
  }

  oldInfo.category.name = newName;
  
  const oldPathParts = oldPath.split(' / ');
  const newPathParts = oldPathParts.slice(0, -1);
  newPathParts.push(newName);
  const newFullPath = newPathParts.join(' / ');
  
  if (currentCategoryPath === oldPath) {
    currentCategoryPath = newFullPath;
  } else if (currentCategoryPath.startsWith(oldPath + ' / ')) {
    const suffix = currentCategoryPath.substring(oldPath.length);
    currentCategoryPath = newFullPath + suffix;
  }
  
  renderCategoryOptions(currentCategoryPath);
  renderCategoryList();
  renderBookmarkList();
}


function getBookmarkIconUrl(item) {
    if (item.icon) return item.icon;
    
    const normalizedUrl = normalizeUrl(item.url);
    if (normalizedUrl) {
      return `https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${normalizedUrl}&size=128`;
    }
    
    return 'https://www.google.com/s2/favicons?domain=default.com';
}

function getCurrentBookmarks() {
    if (!currentCategoryPath) return [];
    
    const info = findCategoryAndParent(currentCategoryPath);
    return info.category ? info.category.bookmarks : [];
}


function renderBookmarkList() {
  listContainer.innerHTML = "";
  const currentCategoryObj = findCategoryAndParent(currentCategoryPath).category;
  
  if (!currentCategoryObj || !currentCategoryObj.bookmarks || currentCategoryObj.bookmarks.length === 0) {
      listContainer.innerHTML = `<p style="text-align:center; color:#777; width:100%;">å½“å‰åˆ†ç±»æš‚æ— ä¹¦ç­¾ã€‚è¯·åœ¨ä¸Šæ–¹è¡¨å•æ·»åŠ ã€‚</p>`;
      return;
  }
  
  currentCategoryObj.bookmarks.forEach((item, idx) => {
    const div = document.createElement("div");
    div.className = "bookmark";
    
    div.setAttribute('draggable', 'true'); 
    div.dataset.index = idx;
    
    const iconUrl = getBookmarkIconUrl(item);

    div.innerHTML = `
      <img src="${iconUrl}" onerror="this.onerror=null;this.src='https://www.google.com/s2/favicons?domain=default.com';" alt="ä¹¦ç­¾å›¾æ ‡"/>
      <span>${item.name}</span>
      <div class="bookmark-actions">
        <button class="edit-btn">ç¼–è¾‘</button>
        <button class="delete-btn">åˆ é™¤</button>
      </div>
    `;
    
    div.addEventListener('dragstart', handleBookmarkDragStart);
    div.addEventListener('dragover', handleBookmarkDragOver);
    div.addEventListener('dragleave', handleBookmarkDragLeave);
    div.addEventListener('drop', handleBookmarkDrop);
    div.addEventListener('dragend', handleBookmarkDragEnd);
    
    div.onclick = (e) => {
      if (!e.target.closest("button")) window.open(item.url, "_blank");
    };
    div.querySelector('.bookmark-actions .edit-btn').onclick = (e) => {
        e.stopPropagation();
        editBookmark(idx);
    };
    div.querySelector('.bookmark-actions .delete-btn').onclick = (e) => {
        e.stopPropagation();
        if (confirm(`ç¡®å®šè¦åˆ é™¤ä¹¦ç­¾ "${item.name}" å—ï¼Ÿ`)) {
             deleteBookmark(idx, item.name);
        }
    };
    listContainer.appendChild(div);
  });
}

function moveBookmarkInArray(array, fromIndex, toIndex) {
    if (fromIndex === toIndex || fromIndex < 0 || fromIndex >= array.length || toIndex < 0 || toIndex >= array.length) {
        return;
    }
    const [element] = array.splice(fromIndex, 1);
    array.splice(toIndex, 0, element);
}

function handleBookmarkDragStart(e) {
    const dragItem = e.target.closest('.bookmark');
    if (!dragItem) return;
    
    draggedBookmarkIndex = parseInt(dragItem.dataset.index, 10);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', draggedBookmarkIndex);
    
    setTimeout(() => {
        dragItem.classList.add('dragging');
    }, 0);
}

function handleBookmarkDragOver(e) {
    e.preventDefault();
    const dropTargetEl = e.target.closest('.bookmark');
    const container = document.getElementById("bookmarkList");
    
    container.querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
    });

    if (dropTargetEl && dropTargetEl.dataset.index !== String(draggedBookmarkIndex)) {
        dropTargetEl.classList.add('drag-over');
        e.dataTransfer.dropEffect = 'move';
    }
}

function handleBookmarkDragLeave(e) {
    e.target.closest('.bookmark')?.classList.remove('drag-over');
}

function handleBookmarkDrop(e) {
    e.preventDefault();
    const dropTargetEl = e.target.closest('.bookmark');
    
    if (draggedBookmarkIndex !== null && dropTargetEl) {
        const targetIndex = parseInt(dropTargetEl.dataset.index, 10);
        
        const currentCategoryObj = findCategoryAndParent(currentCategoryPath).category;
        if (!currentCategoryObj) return;

        moveBookmarkInArray(currentCategoryObj.bookmarks, draggedBookmarkIndex, targetIndex);
        
        saveDataToServer("ä¹¦ç­¾æ’åºæˆåŠŸ"); 
        renderBookmarkList(); 
    }
    
    handleBookmarkDragEnd(e);
}

function handleBookmarkDragEnd(e) {
    e.target.closest('.bookmark')?.classList.remove('dragging');
    document.getElementById("bookmarkList").querySelectorAll('.drag-over').forEach(el => {
        el.classList.remove('drag-over');
    });
    draggedBookmarkIndex = null;
}

function editBookmark(idx) {
  const currentCategoryObj = findCategoryAndParent(currentCategoryPath).category;
  if (!currentCategoryObj) return;
  
  const item = currentCategoryObj.bookmarks[idx];
  nameInput.value = item.name;
  urlInput.value = item.url;
  iconInput.value = item.icon || "";
  editingIndex = idx;
  editingCategoryPath = currentCategoryPath;
  renderCategoryOptions(currentCategoryPath);
  nameInput.focus();
  saveBtn.textContent = "æ›´æ–°ä¹¦ç­¾"; 
}

function deleteBookmark(idx, name) {
  const currentCategoryObj = findCategoryAndParent(currentCategoryPath).category;
  if (!currentCategoryObj) return;
  
  currentCategoryObj.bookmarks.splice(idx, 1);
  saveDataToServer(`ä¹¦ç­¾ [${name}] åˆ é™¤æˆåŠŸ`);
  renderBookmarkList();
}

function resetForm() {
    editingIndex = null; 
    editingCategoryPath = null;
    nameInput.value = ""; 
    urlInput.value = ""; 
    iconInput.value = "";
    saveBtn.textContent = "ä¿å­˜ä¹¦ç­¾";
    
    renderCategoryOptions(); 
}

saveBtn.onclick = () => {
  const name = nameInput.value.trim();
  let url = urlInput.value.trim(); 
  const icon = iconInput.value.trim();
  const selectedCategoryPath = categorySelect.value;
  const newCategoryInfo = findCategoryAndParent(selectedCategoryPath);
  const newCategoryObj = newCategoryInfo.category;
  let successMessage = "";

  if (!selectedCategoryPath || !newCategoryObj) return alert("è¯·å…ˆæ·»åŠ ä¸€ä¸ªåˆ†ç±»å†ä¿å­˜ä¹¦ç­¾ï¼");
  if (!name || !url) return alert("åç§°å’ŒURLä¸èƒ½ä¸ºç©º");

  url = normalizeUrl(url);

  const bookmark = { name, url, icon };

  if (editingIndex !== null && editingCategoryPath !== null) {
    
    if (editingCategoryPath !== selectedCategoryPath) {
        const oldCategoryInfo = findCategoryAndParent(editingCategoryPath);
        const oldCategoryObj = oldCategoryInfo.category;
        
        if (oldCategoryObj) {
            const oldIndex = oldCategoryObj.bookmarks.findIndex(b => b.name === oldCategoryObj.bookmarks[editingIndex].name && b.url === oldCategoryObj.bookmarks[editingIndex].url);
            if(oldIndex !== -1) oldCategoryObj.bookmarks.splice(oldIndex, 1);
        }
        newCategoryObj.bookmarks.push(bookmark);
        successMessage = `ä¹¦ç­¾ [${name}] å·²ç§»åŠ¨/æ›´æ–°`;
    } else {
        newCategoryObj.bookmarks[editingIndex] = bookmark;
        successMessage = `ä¹¦ç­¾ [${name}] æ›´æ–°æˆåŠŸ`;
    }
  } else {
    newCategoryObj.bookmarks.push(bookmark);
    successMessage = `ä¹¦ç­¾ [${name}] æ·»åŠ æˆåŠŸ`;
  }

  saveDataToServer(successMessage); 
  
  resetForm();
  
  currentCategoryPath = selectedCategoryPath;
  renderCategoryList();
  renderBookmarkList();
  renderCategoryOptions();
};

urlInput.addEventListener('blur', () => {
  const urlValue = urlInput.value.trim();
  
  if (urlValue && !iconInput.value.trim()) {
    const fullUrl = normalizeUrl(urlValue);
    const faviconUrl = `https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=${fullUrl}&size=128`;
    iconInput.value = faviconUrl;
  }
});


checkSessionLogin();

document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>

</body>
</html>
